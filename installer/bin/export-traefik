#!/bin/sh

set -eu

if [ -d "/host/traefik" ]; then
	echo "Backing up old traefik folder on host"
	mv -v /host/traefik /host/traefik.$(date +"%Y%m%d%H%M%S")
fi

rm -rf /tmp/traefik

rsync -rq /installer/template/traefik /tmp

rm -rf /tmp/traefik/.env \
    /tmp/traefik/.env-override \
    /tmp/traefik/docker-compose.override.yml

cp /tmp/traefik/docker-compose.override.yml.dist /tmp/traefik/docker-compose.override.yml

cat << EOF > /tmp/traefik/.env
APP_HOSTS=${TRAEFIK_UI_HOST}
APP_AUTH_BASIC='$(htpasswd -bn ${TRAEFIK_UI_USERNAME} ${TRAEFIK_UI_PASSWORD})'
ACME_EMAIL=${TRAEFIK_ACME_EMAIL:-}
COCOTTE_MACHINE=${COCOTTE_MACHINE}
MACHINE_STORAGE_PATH=${MACHINE_STORAGE_PATH}
EOF

rsync -rq /tmp/traefik /host

rm -rf /tmp/traefik
