#!/bin/sh

set -eu

XDEBUG_INI=$PWD/installer/etc/xdebug.ini

if [ "$1" = 'test' ]; then
    set -a
    . .env
    set +a
    shift

    GIT_COMMITTED_AT=$(git log -1 --pretty=format:%ct)
    GIT_COMMIT_SHA=$(git rev-parse HEAD)
    GIT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
else
    GIT_COMMITTED_AT=$(if [ "$TRAVIS_PULL_REQUEST" = false ]; then git log -1 --pretty=format:%ct; else git log -1 --skip 1 --pretty=format:%ct; fi)
    GIT_COMMIT_SHA=$TRAVIS_COMMIT
    GIT_BRANCH=$TRAVIS_BRANCH
fi

cd host

docker run -it --rm \
    -e ACME_ENABLED="${ACME_ENABLED:-true}" \
    -e DIGITAL_OCEAN_API_TOKEN="${DIGITAL_OCEAN_API_TOKEN}" \
    -e MACHINE_NAME="${MACHINE_NAME}" \
    -e STATIC_SITE_HOSTNAME="${STATIC_SITE_HOSTNAME}" \
    -e STATIC_SITE_NAMESPACE="${STATIC_SITE_NAMESPACE}" \
    -e TRAEFIK_UI_HOSTNAME="${TRAEFIK_UI_HOSTNAME}" \
    -e TRAEFIK_UI_PASSWORD="${TRAEFIK_UI_PASSWORD}" \
    -e TRAEFIK_UI_USERNAME="${TRAEFIK_UI_USERNAME}" \
    -e GIT_COMMITTED_AT="${GIT_COMMITTED_AT}" \
    -e GIT_COMMIT_SHA="${GIT_COMMIT_SHA}" \
    -e GIT_BRANCH="${GIT_BRANCH}" \
    -e CC_TEST_REPORTER_ID="${CC_TEST_REPORTER_ID}" \
    -v "$(pwd)":/host \
    -v ${XDEBUG_INI}:/etc/php7/conf.d/xdebug.ini:ro \
    chrif/cocotte \
    "$@"
