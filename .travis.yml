language: generic
sudo: required
dist: trusty

before_install:
  # install docker
- curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
- sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu
  $(lsb_release -cs) stable"
- sudo apt-get update
- sudo apt-get -y install docker-ce=18.03.0~ce-0~ubuntu
  # install docker-machine
- curl -L https://github.com/docker/machine/releases/download/v0.14.0/docker-machine-`uname
  -s`-`uname -m` >/tmp/docker-machine
- sudo install /tmp/docker-machine /usr/local/bin/docker-machine
  # install docker-compose
- sudo rm /usr/local/bin/docker-compose
- curl -L https://github.com/docker/compose/releases/download/1.20.1/docker-compose-`uname
  -s`-`uname -m` > docker-compose
- chmod +x docker-compose
- sudo mv docker-compose /usr/local/bin

install:
- chmod +x bin/*
- docker pull chrif/cocotte || true # reuse layers if possible
- docker-compose build cocotte
- docker images | grep chrif/cocotte

#script:
#- ./bin/cmd phpunit --exclude-group=functional
#- ./bin/install -n -vvv
#- ./bin/static-site -n -vvv
#- if [ "${KEEP_MACHINE_AFTER:-false}" = false ]; then ./bin/cmd console networking -n -vvv --remove ${STATIC_SITE_HOSTNAME}; else true; fi
#- if [ "${KEEP_MACHINE_AFTER:-false}" = false ]; then ./bin/uninstall -n -vvv; else echo "Machine not removed."; fi

deploy:
  - provider: script
    skip_cleanup: true
    script: echo "$DOCKER_PASSWORD" | docker login -u chrif --password-stdin && \
            docker tag chrif/cocotte:latest "chrif/cocotte:${TRAVIS_TAG}" && \
            docker save -o "chrif-cocotte-${TRAVIS_TAG}.tar" "chrif/cocotte:${TRAVIS_TAG}" && \
            docker push chrif/cocotte:latest && docker push "chrif/cocotte:${TRAVIS_TAG}"
    on:
      tags: true
  - provider: releases
    skip_cleanup: true
    file: "chrif-cocotte-${TRAVIS_TAG}.tar"
    api_key:
      secure: "uU933GDZmaJvcYw3L4keVYgEAUAn/ZEMI9YmeoRSSQi+MUht3cKWpeBMH4buXJ50CcGKRthnuCveDQLcv2VlD5BglqxHXzjIGts6/3kPAxnJztrzFYrNp0r0Hm596k1c4xEwlDd6+1GoGRf+SEoLC7YsOsa394HQbSx5D4CqQBzLFxHMraHfcOLlkA17QRgtu221ZwV/avkd/z7YIvNOC9hgGPh5exFGSqhXLHPnkIArozzO18KeUrsIbrL7oYEgzIZEoWWuQr3VPjdX1SCxmn3/vUOzevQBHP226Ny2Ry+/WAfXeyFfRiggwUJd0gDgmMkbyGB2E3rRJ3ZlIPhtwJkjhYN9N6OS5RGbZojh4dEc9Y+fZGgigGyZLPiTP2+1miD0vVDIXlsw8ILi3qOGGeJAqMtYyUjLkOz17k8hN9OFQRSFuphy2dgHsgWg9NIzwVxqJk/3Qsq6xpi3rucOxxq9kst5wxi91+fUEd/ifeEnuJFSu7ySrocapipB+gu/Tg4MT3MdpMd9vfwbo31eLlJKtQN4fVFUt9rx/GIBPQloYVK/QCMH6nrMUu1ytUIT/AGT8dDGqRV6G3FS0i8trSvsj5dTuB4fNYlL1o3cWz7SAk4vWN4oO+bePk1322ULZPUuyfPuBN4aItHJRwG3OD2JwlahkrqA42vB8xCD1NE="
    on:
      tags: true

env:
  global:
    # DIGITAL_OCEAN_API_TOKEN (set in in repo settings)
    - COCOTTE_VERSION=${TRAVIS_TAG}
    - GIT_COMMIT_ID=${TRAVIS_COMMIT}
    - MACHINE_NAME=cocotte-travis-${TRAVIS_BUILD_ID}
    # STATIC_SITE_HOSTNAME (set in in repo settings)
    - STATIC_SITE_NAMESPACE=static-site
    # TRAEFIK_UI_HOSTNAME (set in in repo settings)
    # TRAEFIK_UI_PASSWORD
    - secure: "vDD7Z8hwwiVC8ervHXFoLQt4SPP1mTqHt2E/SchSxGIqk2WszsvL9NYfgu+cB/6JrxjL/25LcXgqH4qJPXs66I/p0Kx/ALj1RvD/6Pkh3OeDH3fWc6Bgoe90+uiGg5kaP/XtyEiD4lthug7vxOXsW/3W+CEC06jEb9bxvSW54xa38AmbSkZ5LcT+gWMOk2I48HfdmsGS2K6zFacjAexJ2P3TVz46ttDzwE2hB7vWiuhtpPv8BfhvGTKhNgquWOQUdPm2vA+Rx9pY733yl1XXJr/OYlaxrKu5JjimmQV3wMgZMZe4PqrRYIpZo1q7dVdlePwAhU5H57zjkuHMzUDgu0rfCW7S1+cooybrO2BGM0n/Bee5HN549GkFjGhNlvaV/uk0Wu03L9xkwria8OFM9mRLnOuSDHa2GK9TvYZ1RAVB1QsjcApIEIpLS7R5PFxPzVFIaBvPgD1OFhL+CU0BfVtWeGZLV93zxiWkm3fbzP+dMDnzl/Mx+mHe+yBTkGheMelzlHYGGSwY/DDWJ2/i8fc3wgvp0fLV8fhSY3HmAwt3lKnEMjMURt+2zI2/fOMk9WtJF1oxxlMhTYaY2/Dc9OsVpV1rIdjDXY2CmwA7ZxPwmrpxvLFRD7CIAn9HdVHpDpgTkQv/3u7F/7h4/qIiKXmRQjIS4j5Jjykj/NBWHSA="
    - TRAEFIK_UI_USERNAME=admin
